#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="."
ROOT_DIR="."

OPENAI_KEY_PATH=${OPENAI_KEY_PATH:-~/.openai_api_key}
if [ -f "$OPENAI_KEY_PATH" ]; then
  export OPENAI_API_KEY=$(cat "$OPENAI_KEY_PATH")
elif [ -z "${OPENAI_API_KEY:-}" ]; then
  echo "OPENAI_API_KEY is not set and OPENAI_KEY_PATH does not exist at $OPENAI_KEY_PATH" >&2
  exit 1
fi
VERSION=${VERSION:-'v1_v1_v1'}
STEP4_NAME=${STEP4_NAME:-step4}
STEP5_NAME=${STEP5_NAME:-step5}

NUM_SAMPLES=${NUM_SAMPLES:-20}
SRC_NAME=${SRC_NAME:-Qwen3_8B_bfloat16_fixed_qwen_template_40k_polaris_data_53K_1_1k}
INPUT_SUFFIX=${INPUT_SUFFIX:-}
DIR_NAME=${DIR_NAME:-${SRC_NAME}${INPUT_SUFFIX}_${NUM_SAMPLES}samples}
DATA_PATH=${ROOT_DIR}/data/${DIR_NAME}

# Filter step-4 trajectories into step-5, preserving structure (skipping the old step-5 stage)
python "$ROOT_DIR/src/filter-format-correct-and-obtain-stats.py" \
  --input  "${DATA_PATH}_${STEP4_NAME}_${VERSION}" \
  --output "${DATA_PATH}_${STEP5_NAME}_${VERSION}" \
  --glob   "*.txt" \
  --skip_conclusion_check \
  --workers 128
